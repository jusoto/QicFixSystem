/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package appLogic;

import appLogic.AppLogicFacade;
import entity.DatastoreFacade;
import entity.User;
import java.security.GeneralSecurityException;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import javax.security.auth.login.LoginException;

/**
 *
 * @author Juan
 */
public final class Authenticator {

    private static Authenticator authenticator = new Authenticator();

    // A user storage which stores <username, password>
    //private final Map<String, String> usersStorage = new HashMap();
    //AppLogicFacade appLogic = new AppLogicFacade();
    // A service key storage which stores <service_key, username>
    //private final Map<String, String> serviceKeysStorage = new HashMap();
    // An authentication token storage which stores <service_key, auth_token>.
    private static final Map<String, String> authorizationTokensStorage = new HashMap();

    private Authenticator() {
        // The usersStorage pretty much represents a user table in the database
        //usersStorage.put("username1", "passwordForUser1");
        //usersStorage.put("username2", "passwordForUser2");
        //usersStorage.put("username3", "passwordForUser3");

        /**
         * Service keys are pre-generated by the system and is given to the
         * authorized client who wants to have access to the REST API. Here,
         * only username1 and username2 is given the REST service access with
         * their respective service keys.
         */
        //serviceKeysStorage.put("f80ebc87-ad5c-4b29-9366-5359768df5a1", "username1");
        //serviceKeysStorage.put("3b91cab8-926f-49b6-ba00-920bcf934c2a", "username2");
    }

    public static Authenticator getInstance() {
        /*if (authenticator == null) {
            authenticator = new Authenticator();
        }*/

        return authenticator;
    }

    public String login(String email, String password) throws LoginException {
        /*if (serviceKeysStorage.containsKey(serviceKey)) {
            String usernameMatch = serviceKeysStorage.get(serviceKey);

            if (usernameMatch.equals(email) && usersStorage.containsKey(email)) {*/
        //String passwordMatch = usersStorage.get(email);
        DatastoreFacade obj = new DatastoreFacade();
        if (obj.validateUser(email, password)) {

            /**
             * Once all params are matched, the authToken will be generated and
             * will be stored in the authorizationTokensStorage. The authToken
             * will be needed for every REST API invocation and is only valid
             * within the login session
             */
            String authToken = UUID.randomUUID().toString();
            authorizationTokensStorage.put(authToken, email);

            return authToken;
        }

        throw new LoginException("LoginException");
    }

    /**
     * The method that pre-validates if the client which invokes the REST API is
     * from a authorized and authenticated source.
     *
     * @param serviceKey The service key
     * @param authToken The authorization token generated after login
     * @return TRUE for acceptance and FALSE for denied.
     */
    public boolean isAuthTokenValid(String authToken, String email) {

        if (authorizationTokensStorage.containsKey(authToken)
                && authorizationTokensStorage.get(authToken).equals(email)) {
            return true;
        }

        return false;
    }

    public void logout(String authToken) throws GeneralSecurityException {

        if (authorizationTokensStorage.containsKey(authToken)) {

            /**
             * When a client logs out, the authentication token will be remove
             * and will be made invalid.
             */
            authorizationTokensStorage.remove(authToken);
            return;
        }

        throw new GeneralSecurityException("Invalid service key and authorization token match.");
    }

}
